#! /bin/bash

DATABASE=${DATABASE:-/tmp/docker-mailserver/postfix-accounts.cf}

USER="$1"
shift
PASSWD="$@"

usage() {
	echo -e "Usage: updatemailuser <user@domain.tld> [password]\n \
	\n \
	Please provide an unescaped password(without qoutes),\n \
	since everything after the E-Mail address will be treated as the password.\n \
	\n \
	If a password is not provided as an argument, it will be asked for."
}

errex() {
	echo "$@" 1>&2
	exit 1
}

escape() {
	echo "${1//./\\.}"
}

[ -z "$USER" ] && { usage; errex "no username specified"; }

if [ -z "$PASSWD" ]; then
	read -s -p "Enter Password: " PASSWD
	echo
	[ -z "$PASSWD" ] && errex "Password must not be empty"
fi
HASH="$(doveadm pw -s SHA512-CRYPT -u "$USER" -p "$PASSWD")"
grep -qi "^$(escape "$USER")|" $DATABASE 2>/dev/null ||
	errex "User \"$USER\" does not exist"

sed -i "s ^"$USER"|.* "$USER"|"$HASH" " $DATABASE
